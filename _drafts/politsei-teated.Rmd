---
title: "Politseile laekunud teated 24H jooksul"
author: "Toomas Eilat"
date: "`r Sys.Date()`"
layout: post
---

```{r, echo=FALSE}
# Piltide asukoht
knitr::opts_chunk$set(fig.path='{{ site.url }}/img/politsei-teated-')
```

```{r setup, include=FALSE}
# graafikute ja koodi seaded
# library(svglite)  # vajalik svg formaadis piltide salvestamiseks
knitr::opts_chunk$set(
    echo = FALSE, 
    message = FALSE,
    # dev = "svglite",
    dpi = 300,
    warning = FALSE,
    fig.cap = ""
)
```

```{r lae andmed}
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(gganimate)
library(viridis)
library(splitstackshape)
library(gridExtra)
library(tidyr)
library(ggbeeswarm)
library(plotly)
library(ggthemes)
library(extrafont)
library(htmlwidgets)

# 01_lae_andmed.R scripti tulemuse laadimine
load("C:/Users/toomase/Dropbox/DataScience/R/politsei_koned/data/politsei_postitused.Rdata")

# Töötle teadete andmeid
politsei_postitused <- politsei_postitused_raw %>%
    tbl_df() %>%
    select(-from_id, -from_name, -link) %>%
    # ainult teated facebooki feed-st
    filter(type == "status") %>%
    mutate(tunnus = str_extract(message, "^[^:]+"),  # teatest tunnus
           # teate esitamise aeg
           aeg = str_replace_all(created_time, "T|\\+0000", ""),
           aeg = parse_date_time(aeg, "ymdHMS"),
           aeg = aeg + hours(1),
           tund = hour(aeg),
           tund = ifelse(tund == 0, 24, tund),
           # suuremate tunnuste grupeerimine
           tunnus_toodeldud = ifelse(str_detect(tunnus, "LIIKLUS"), "LIIKLUS", 
                                     tunnus),
           tunnus_toodeldud = ifelse(str_detect(tunnus_toodeldud, "JOOBES"), 
                                                "JOOBES INIMENE", tunnus_toodeldud),
           tunnus_toodeldud = ifelse(str_detect(tunnus_toodeldud, "VÄGIVALD"), 
                                     "VÄGIVALD", tunnus_toodeldud),
           tunnus_toodeldud = ifelse(tunnus_toodeldud %in% c("AVALIK KORD", "LÄRM", 
                                                             "LÕHKUMINE"), "AVALIK KORD", 
                                     tunnus_toodeldud),
           tunnus_toodeldud = ifelse(!tunnus_toodeldud %in% c("VARGUS", "INFO", "LIIKLUS",
                                                              "JOOBES INIMENE", "VÄGIVALD",
                                                              "AVALIK KORD"), "MUU", 
                                     tunnus_toodeldud),
           tunnus = tunnus_toodeldud) 

# Kõik tunnid ja tunnused tabelisse
vorm <- expand.grid(unique(politsei_postitused$tund), unique(politsei_postitused$tunnus))
names(vorm) <- c("tund", "tunnus")

# postituste arv tunnuste ja tundide lõikes
postituste_arv <- politsei_postitused %>%
    group_by(tund, tunnus) %>%
    tally() %>%
    ungroup() %>%
    right_join(vorm) %>%
    mutate(n = ifelse(is.na(n), 0, n),
           am_pm = ifelse(tund > 12, "PM", "AM"))

postituste_arv %>%
    group_by(tund) %>%
    tally() %>%
    arrange((n))

```

Ühel talvisel reedel vastu laupäeva (04.03.2016 - 05.03.2016) viis Politsei läbi aktsiooni, mille käigus postitati 24 tunni jooksul Facebooki infot numbrile 112 tulnud väljakutsete kohta. Kokku laekus selle aja jooksul __668__ teadet, mis annavad päris hea ülevaate sellest, kuidas paistab elu Eestimaal välja läbi politsei silmade.

Proovin läbi erinevate graafiku tüüpide teadetes olevat infot pisut visualiseerida. Alustuseks üks animatsioon, mis kujutab tundide lõikes teadete arvu. Tumedamat tooni postid kujutavad öötunde ning heledamad päevast aega. Maksimaalselt laekus teateid ühe tunni jooksul õhtul kella 19 ajal, __43__. Huvitava kokkusattumusena saabus kõige vähem teateid aga hommikul kell 7, __11__.

```{r teated_kokku, fig.width = 8, fig.height = 6, fig.align = "center", message = FALSE, warning = FALSE}

# gif graafikus värvid öötunnid tumedad ja päeval heledad
fill <- data_frame(c(1:13, 12:2), c(1:24))
names(fill) <- c("fill", "tund")

# gif graafik teadete arvuga kokku tundide lõikes
animeeritud_graafik <- postituste_arv %>%
    # pealkirjas kasutatav kellaaeg
    mutate(tund_frame = str_c(ifelse(tund < 10, "0", ""),
                              tund, ".00 - ", 
                              ifelse((tund + 1) == 25, "01",
                                     ifelse((tund + 1) < 10, str_c("0", tund + 1), 
                                            tund + 1)),
                              ".00", sep = ""),
           tund_am_pm = ifelse(am_pm == "PM", tund - 12, tund)) %>%
    group_by(tund, tund_am_pm, tund_frame, am_pm) %>%
    summarise(n = sum(n)) %>%
    ungroup() %>%
    left_join(fill) %>%
    ggplot(aes(x = factor(tund_am_pm), y = n, group = am_pm, fill = fill, 
               frame = tund_frame)) +
    geom_bar(aes(cumulative = TRUE), stat = "identity", position = "dodge") +
    coord_polar(theta = "x", start = 0.26) +
    xlab("") +
    ylab("") +
    scale_fill_viridis() +
    labs(title = "Teated kell") +
    theme(axis.ticks = element_blank(), 
          axis.text.y = element_blank(), 
          panel.background = element_blank(), 
          panel.grid.major.x = element_line(colour = "grey", lineend = 5),
          axis.text.x = element_text(size = 15, hjust = 300), 
          legend.title = element_blank(),
          legend.position = "none")

# salvesta graafik GIF-na
gg_animate(animeeritud_graafik, interval = .5, saver = "gif")

```



<iframe frameborder="0" width="800" height="600" 
        sandbox="allow-same-origin allow-scripts"
        scrolling="no" seamless="seamless"
        src="/files/politsei-teated.html">
</iframe>

## Kuidas?
Nagu ikka, tegin andmetöötluse ja visualiseerimise R-s. Lähtekoodiga võib tutvuda siin: [https://github.com/toomase/temperatuur](https://github.com/toomase/temperatuur). Inspiratsiooni sain blogipostitusest: [How to: Weather Radials](http://jkunst.com/r/how-to-weather-radials/).